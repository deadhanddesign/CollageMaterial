<div class="sticky-track">
  <form id="card-container__filter" action="{{ routes.search_url }}" method="get" role="search">
    <md-outlined-text-field id="search" label="Search" name="q" value="{{ search.terms | escape }}">
      <input type="hidden" name="type" value="product">
      <md-icon slot="leading-icon">search</md-icon>
    </md-outlined-text-field>

    <script type="module">
      document.getElementById('search').addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
          event.preventDefault(); // Prevent the default action (if any)
          this.form.submit(); // Submit the form
        }
      });
    </script>

    <p>Showing {{ search.results_count }} results</p>

    {%- for filter in search.filters -%}
      <details style="position: relative">
        <summary>
          {{ filter.label }}
          <span></span>
        </summary>

        <div class="filter-group-display__option-grid">
          {%- case filter.type -%}
            {%- when 'list' -%}
              {%- for filter_value in filter.values -%}
                <label
                  for="Filter-{{ filter.param_name }}-{{ forloop.index }}"
                  aria-label="{{ filter_value.param_name }}"
                >
                  <md-checkbox
                    name="{{ filter_value.param_name }}"
                    value="{{ filter_value.value }}"
                    id="Filter-{{ filter.param_name }}-{{ forloop.index }}"
                    {% if filter_value.active -%}
                      checked
                    {%- endif %}
                    {% if filter_value.count == 0 and filter_value.active == false -%}
                      disabled
                    {%- endif %}
                  ></md-checkbox>
                  <span>
                    {%- case filter_value.display.type -%}
                      {%- when 'colors' -%}
                        {% liquid
                          assign size_limit = filter_value.display.value.size | at_most: 4
                          assign rotation = '0deg'
                          if size_limit == 2
                            assign rotation = '45deg'
                          endif
                          assign angle_increment = 360 | divided_by: size_limit
                          assign angle = 0
                        %}
                        {%- capture conic_gradient -%}
                                      {%- for color in filter_value.display.value limit: size_limit -%}
                                        {{ color }} {{ angle }}deg{%- assign angle = angle | plus: angle_increment %} {{ angle }}deg{%- unless forloop.last %}, {%- endunless -%}
                                      {%- endfor -%}
                                    {%- endcapture -%}
                        <span
                          style="
                            width: 25px;
                            height: 25px;
                            border-radius: 50%;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            background: conic-gradient({{ conic_gradient }}); transform: rotateZ({{ rotation }});
                          "
                        ></span>
                      {%- when 'image' -%}
                        {{
                          filter_value.display.value
                          | image_url: width: 25
                          | image_tag: alt: filter_value.display.value.alt
                        }}
                      {%- else -%}
                        <span class="visual-display__child"></span>
                    {%- endcase -%}
                  </span>
                  {{ filter_value.label }}
                </label>
              {%- endfor -%}
            {%- when 'price_range' -%}
              <md-slider
                id="price-range-slider"
                range
                min="{{ filter.range_min | money_without_currency | replace: ',', '' }}"
                max="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                {% if filter.min_value.value -%}
                  value-start="{{ filter.min_value.value | money_without_currency | replace: ',', '' }}"
                {% else %}
                  value-start="0"
                {%- endif %}
                {% if filter.max_value.value -%}
                  value-end="{{ filter.max_value.value | money_without_currency | replace: ',', '' }}"
                {% else %}
                  value-end="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                {%- endif %}
                labeled
                step="5"
              ></md-slider>
              <md-outlined-text-field
                name="{{ filter.min_value.param_name }}"
                id="Filter-{{ filter.min_value.param_name }}"
                label="From"
                {% if filter.min_value.value -%}
                  value="{{ filter.min_value.value | money_without_currency | replace: ',', '' }}"
                {% else %}
                  value="0"
                {%- endif %}
                type="number"
                placeholder="0"
                min="0"
                max="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                step="5"
                prefix-text="$"
              >
              </md-outlined-text-field>
              <md-outlined-text-field
                name="{{ filter.max_value.param_name }}"
                id="Filter-{{ filter.max_value.param_name }}"
                label="To"
                {% if filter.max_value.value -%}
                  value="{{ filter.max_value.value | money_without_currency | replace: ',', '' }}"
                {% else %}
                  value="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                {%- endif %}
                type="number"
                placeholder="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                min="0"
                max="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                step="5"
                prefix-text="$"
              >
              </md-outlined-text-field>
          {%- endcase -%}
        </div>
      </details>
      <md-divider></md-divider>
    {%- endfor -%}

    <div class="button-wrapper">
      <md-text-button href="{{ search.url }}?sort_by={{ search.sort_by }}">Clear Filters</md-text-button>
      <md-filled-tonal-button type="submit">Apply Filters</md-filled-tonal-button>
    </div>
  </form>
</div>

<script type="module">
  document.addEventListener('DOMContentLoaded', function () {
    const slider = document.querySelector('#price-range-slider');
    let inputMin = document.getElementById(`Filter-filter.v.price.gte`);
    let inputMax = document.getElementById(`Filter-filter.v.price.lte`);

    slider.addEventListener('input', (event) => {
      let sliderStart = slider.valueStart;
      let sliderEnd = slider.valueEnd;

      inputMin.value = sliderStart;
      inputMax.value = sliderEnd;
    });

    inputMin.addEventListener('input', (event) => {
      let inputMinValue = inputMin.value;

      slider.valueStart = inputMinValue;
    });

    inputMax.addEventListener('input', (event) => {
      let inputMaxValue = inputMax.value;

      slider.valueEnd = inputMaxValue;
    });
  });
</script>
